name: Reusable
on:
  workflow_call:
    inputs:
      ros_distro:
        type: string
        required: true
      container_image:
        type: string
        required: true
jobs:
  check_relevant_changes:
    runs-on: ubuntu-latest
    outputs:
      continue_run: ${{ steps.check.outputs.continue_run }}
    env:
      IGNORED_FOLDERS: "rko_lio/python|docs|tests/python"
      IGNORED_FILES: "pyproject.toml|CHANGELOG.rst|LICENSE|README.md"
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - id: check
        run: |
          changed_files=$(git diff --name-only origin/master)
          echo "Changed files: $changed_files"
          if echo "$changed_files" | grep -vE "^($IGNORED_FOLDERS)/|^($IGNORED_FILES)$" > /dev/null; then
            echo "continue_run=true" >> $GITHUB_OUTPUT
          else
            echo "continue_run=false" >> $GITHUB_OUTPUT
          fi
  ros_build_with_rosdep:
    needs: check_relevant_changes
    if: needs.check_relevant_changes.outputs.continue_run == 'true'
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.container_image }}
    steps:
      - uses: actions/checkout@v6
      - name: Install build tools
        run: |
          apt-get update
          apt-get install -y build-essential cmake
      - name: Source ROS environment, install dependencies, and build
        run: |
          . /opt/ros/${{ inputs.ros_distro }}/setup.sh
          rosdep init 2>/dev/null || true
          rosdep update
          rosdep install --from-paths . --ignore-src -r -y
          colcon build --event-handlers console_direct+
  ros_build_no_rosdep:
    needs: check_relevant_changes
    if: needs.check_relevant_changes.outputs.continue_run == 'true'
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.container_image }}
    steps:
      - uses: actions/checkout@v6
      - name: Install build tools
        run: |
          apt-get update
          apt-get install -y build-essential cmake
      - name: Source ROS environment and build with extra CMake args
        run: |
          . /opt/ros/${{ inputs.ros_distro }}/setup.sh
          colcon build --event-handlers console_direct+ --cmake-args -DRKO_LIO_FETCH_CONTENT_DEPS=ON
