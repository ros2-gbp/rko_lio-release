name: Publish to PyPI.org
on:
  release:
    types: [published]
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
jobs:
  cibuildwheel:
    name: Build py wheels on ${{ matrix.os }}
    env:
      GIT_LFS_SKIP_SMUDGE: 1
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm, windows-2022, macos-15]
    steps:
      - uses: actions/checkout@v5
      - name: Build test wheels (only PRs)
        if: github.event_name != 'release'
        uses: pypa/cibuildwheel@v3.2.0
        env: # build 1 build per platform just to make sure we can do it later when releasing
          CIBW_BUILD: "cp312-*"
        with:
          package-dir: ${{github.workspace}}/python/
      - name: Build all wheels (release)
        if: github.event_name == 'release'
        uses: pypa/cibuildwheel@v3.2.0
        with:
          package-dir: ${{github.workspace}}/python/
      - uses: actions/upload-artifact@v4
        with:
          name: artifact-${{ matrix.os }}
          path: ./wheelhouse/*.whl
  pypi:
    name: Publish wheels to PyPI
    if: github.event_name == 'release'
    needs: [cibuildwheel]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v5
        with:
          pattern: artifact*
          path: dist
          merge-multiple: true
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          # TODO: switch to trusted publishing
